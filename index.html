<html>

<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
</head>

<body>
  <div id="container">
    <span id="no-js">
      Javascript not fully supported - please upgrade your browser!
    </span>
  </div>
</body>

<style>
.foo {
  font-size: 20px;
}
</style>

<script src="aight.js"></script>
<script src="jquery-1.12.0.js"></script>
<script src="domchanger.js"></script>

<script>
function TodoApp(emit, refresh) {
  var items = [];
  var text = "";

  return { render: render };

  function render() {
    return ["div",
      ["h1", "TODO"],
      ["form", { onsubmit: handleSubmit },
        ["input", {
          onchange: onChange,
          onkeypress: onKeyPress,
          value: text,
          id: "input",
          klass: "foo"
        }],
        ["button", { klass: "foo" }, "Add #", items.length + 1]
      ],
      [TodoList.bind(null, refresh), items]
    ];
  }

  function handleSubmit(evt) {
    evt.preventDefault();
    if (text !== "") {
      items.push(text);
      text = "";
      refresh();
    };
  }

  function onKeyPress(evt) {
    text = document.getElementById("input").value;
    if (evt.keyCode == 13) {
      if (text !== "") {
        items.push(text);
        text = "";
        refresh();
      };
    };
  }

  function onChange(evt) {
    var val = evt.target.value;
    text = val;
    evt.preventDefault();
  }
}

function TodoList(refresh) {
  var refresh = refresh;
  return { render: render };
  function render(items) {
    return ["ul", items.map(function (itemText, index) {
      return [ TodoItem.bind(null, items, index, refresh), itemText ]
    })];
  }
}

function TodoItem(array, index, refresh) {
  var active = false;
  var index = index;
  var array = array;
  var refresh = refresh;
  return { render: render };
  function render(text) {
    return ["div",
      [
        [
          "input", {
            onchange: itemOnChange.bind(null, refresh, array, index),
            onblur: itemOnBlur.bind(null, index),
            onkeypress: itemOnKeyPress.bind(null, refresh, array, index),
            klass: "foo input",
            value: array[index],
            style: { display: active ? "inherit" : "none" }
          }
        ],
        [
          "span", {
            klass: "foo",
            onclick: itemOnClick.bind(null, refresh, index),
            style: { display: !active ? "inherit" : "none" }
          },
          text
        ]
      ]
    ]
  }

  function itemOnClick(refresh, index, evt) {
    active = true;
    refresh();
    setTimeout(function() {
      $(".input")[index].select();
    }, 50);
  }

  function itemOnChange(refresh, array, index, evt) {
    array[index] = evt.target.value
    refresh();
  }

  function itemOnKeyPress(refresh, array, index, evt) {
    var text = $(".input")[index].value;

    if (evt.keyCode == 13) {
      if (text !== "") {
        array[index] = text;
        active = false;
        refresh();
      };
    };
  }

  function itemOnBlur(index, evt) {
    active = false;
    refresh();
    setTimeout(function() {
      $(".input")[index].select();
    }, 50);
  }
}

domChanger(TodoApp, document.getElementById("container")).update()
document.getElementById("no-js").remove();
</script>

</html>
